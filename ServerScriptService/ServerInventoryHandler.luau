-- ðŸ“‚ Script: ServerInventoryHandler
-- ðŸ“ å ´æ‰€: ServerScriptService
-- ðŸŽ® æ¦‚è¦: ã‚µãƒ¼ãƒãƒ¼å´ã§ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã”ã¨ã®ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªç®¡ç†ã€ã‚¢ã‚¤ãƒ†ãƒ ä½¿ç”¨å‡¦ç†ã‚’è¡Œã†

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- InventoryServer.lua
-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã¨ã‚¢ã‚¤ãƒ†ãƒ ä½¿ç”¨å‡¦ç†ã‚’ç®¡ç†

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local UseItemEvent = Instance.new("RemoteEvent")
UseItemEvent.Name = "UseItemEvent"
UseItemEvent.Parent = ReplicatedStorage

local ItemData = require(ReplicatedStorage:WaitForChild("ItemDataModule"))

-- ã‚µãƒ¼ãƒãƒ¼ä¸Šã§ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã”ã¨ã®ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã‚’ä¿æŒ
local Inventories = {}

-- åŠ¹æžœå‡¦ç†ã‚’é–¢æ•°åŒ–ï¼ˆå†åˆ©ç”¨æ€§ã‚¢ãƒƒãƒ—ï¼‰
local function applyItemEffect(player, itemName, itemInfo)
	local character = player.Character
	if not character then return end

	local humanoid = character:FindFirstChild("Humanoid")
	if not humanoid then return end

	if itemInfo.Type == "Heal" then
		humanoid.Health = math.min(humanoid.MaxHealth, humanoid.Health + itemInfo.Amount)
	elseif itemInfo.Type == "Speed" then
		humanoid.WalkSpeed += itemInfo.Amount
		task.delay(itemInfo.Duration or 5, function()
			if humanoid then
				humanoid.WalkSpeed = 16
			end
		end)
	end
end

-- ã‚¢ã‚¤ãƒ†ãƒ ä½¿ç”¨ã®ãƒªãƒ¢ãƒ¼ãƒˆã‚¤ãƒ™ãƒ³ãƒˆ
UseItemEvent.OnServerEvent:Connect(function(player, itemName)
	local inventory = Inventories[player]
	if not inventory then return end

	if inventory[itemName] and inventory[itemName] > 0 then
		local itemInfo = ItemData[itemName]
		if itemInfo then
			applyItemEffect(player, itemName, itemInfo)
			inventory[itemName] -= 1
			if inventory[itemName] <= 0 then
				inventory[itemName] = nil
			end
			print(player.Name .. " ãŒ " .. itemName .. " ã‚’ä½¿ç”¨ã—ã¾ã—ãŸã€‚æ®‹ã‚Š: " .. (inventory[itemName] or 0))
		else
			warn("å®šç¾©ã•ã‚Œã¦ã„ãªã„ã‚¢ã‚¤ãƒ†ãƒ ï¼š" .. itemName)
		end
	else
		warn(player.Name .. " ã¯ " .. itemName .. " ã‚’æ‰€æŒã—ã¦ã„ã¾ã›ã‚“ã€‚")
	end
end)

-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å‚åŠ æ™‚ã€ä»®ã®åœ¨åº«è¿½åŠ 
Players.PlayerAdded:Connect(function(player)
	Inventories[player] = {
		HealthPotion = 2,
		SpeedBoots = 1
	}
end)

-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é€€å‡ºæ™‚ã«ãƒ¡ãƒ¢ãƒªè§£æ”¾
Players.PlayerRemoving:Connect(function(player)
	Inventories[player] = nil
end)

-- ServerScriptServiceå†…ã®Scriptã«è¿½è¨˜ï¼

game.Players.PlayerAdded:Connect(function(player)
	local inventoryFolder = Instance.new("Folder")
	inventoryFolder.Name = "Inventory"
	inventoryFolder.Parent = player

	-- åˆæœŸã‚¢ã‚¤ãƒ†ãƒ ã‚’ã“ã“ã§è¿½åŠ ï¼
	local starterItems = {
		HealthPotion = 2,
		SpeedBoots = 1
	}

	for itemName, count in pairs(starterItems) do
		local intValue = Instance.new("IntValue")
		intValue.Name = itemName
		intValue.Value = count
		intValue.Parent = inventoryFolder
	end
end)

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- InventoryUIãŒPlayerGuiã«è¿½åŠ ã•ã‚Œã‚‹ã®ã‚’å¾…ã¤
local inventoryUI = playerGui:WaitForChild("InventoryUI", 10)  -- 10ç§’å¾…ã¤ï¼ˆtimeoutï¼‰

if not inventoryUI then
	warn("InventoryUIãŒPlayerGuiã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ")
	return
end

local frame = inventoryUI:WaitForChild("Frame")

print("InventoryUIæº–å‚™å®Œäº†")

UserInputService.InputBegan:Connect(function(input, processed)
	print("InputBegan ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«")
	if processed then
		print("Inputã¯å‡¦ç†æ¸ˆã¿ã§ã™")
		return
	end

	if input.KeyCode == Enum.KeyCode.Q then
		frame.Visible = not frame.Visible
		print("Qã‚­ãƒ¼æŠ¼ã•ã‚ŒãŸã‚ˆï¼Frame.Visible=", frame.Visible)
	end
end)

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local inventoryUI = playerGui:WaitForChild("InventoryUI")
local frame = inventoryUI:WaitForChild("Frame")
local scrollingFrame = frame:WaitForChild("ScrollingFrame")

local UseItemFunction = ReplicatedStorage:WaitForChild("UseItemFunction")
local ItemData = require(ReplicatedStorage:WaitForChild("ItemDataModule"))

-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰‹å…ƒã«ã‚ã‚‹ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªãƒ†ãƒ¼ãƒ–ãƒ«
local inventory = {}

-- UIæ›´æ–°é–¢æ•°
local function updateInventoryUI(inventoryTable)
	-- æ—¢å­˜ã®ãƒœã‚¿ãƒ³ã‚’å…¨éƒ¨æ¶ˆã™
	for _, child in ipairs(scrollingFrame:GetChildren()) do
		if child:IsA("TextButton") then
			child:Destroy()
		end
	end

	-- ã‚¢ã‚¤ãƒ†ãƒ ã”ã¨ã«ãƒœã‚¿ãƒ³ã‚’ä½œæˆ
	for itemName, count in pairs(inventoryTable) do
		local data = ItemData[itemName]
		if data then
			local function createButton(itemName, count, data)
				local button = Instance.new("TextButton")
				button.Size = UDim2.new(1, 0, 0, 40)
				button.BackgroundColor3 = Color3.fromRGB(80, 160, 200)
				button.TextColor3 = Color3.new(1, 1, 1)
				button.Text = data.Name .. " x" .. count
				button.Font = Enum.Font.Gotham
				button.TextSize = 16
				button.Parent = scrollingFrame

				button.MouseButton1Click:Connect(function()
					print("ğŸ§ª ä½¿ç”¨ï¼š", itemName)
					local newInventory = UseItemFunction:InvokeServer(itemName)
					if newInventory then
						inventory = newInventory -- æ‰‹å…ƒã®ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªæ›´æ–°
						updateInventoryUI(newInventory)
					else
						warn("âš ï¸ ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªæ›´æ–°ãŒè¿”ã£ã¦ã“ãªã‹ã£ãŸ")
					end
				end)
			end
			createButton(itemName, count, data)
		end
	end
end

-- ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®Inventoryãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦UIè¡¨ç¤º
local function initializeInventory()
	local inventoryFolder = player:WaitForChild("Inventory", 10) -- 10ç§’å¾…ã¤
	if not inventoryFolder then
		warn("Inventoryãƒ•ã‚©ãƒ«ãƒ€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ")
		return
	end

	local tempInventory = {}
	for _, itemValue in pairs(inventoryFolder:GetChildren()) do
		if itemValue:IsA("IntValue") then
			tempInventory[itemValue.Name] = itemValue.Value
		end
	end

	inventory = tempInventory
	updateInventoryUI(inventory)
end

-- æœ€åˆã«å‘¼ã¶
initializeInventory()

-- Qã‚­ãƒ¼ã§ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªUIã®é–‹é–‰
local UserInputService = game:GetService("UserInputService")
UserInputService.InputBegan:Connect(function(input, gameProcessed)
	if gameProcessed then return end
	if input.KeyCode == Enum.KeyCode.Q then
		frame.Visible = not frame.Visible
		print("Qã‚­ãƒ¼ã§InventoryUIè¡¨ç¤ºåˆ‡æ›¿:", frame.Visible)
	end
end)
